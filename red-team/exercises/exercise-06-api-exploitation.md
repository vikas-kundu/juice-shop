# Red Team Exercise 06: API Security & Exploitation

**Difficulty:** ⭐⭐⭐ Advanced  
**Time:** 25 minutes  
**OWASP Category:** A04:2021 - Insecure Design

## Objective

Discover and exploit API vulnerabilities including mass assignment, injection, and business logic flaws.

## Prerequisites

- Completed previous exercises
- Understanding of REST APIs
- Burp Suite or similar proxy tool
- cURL or HTTPie for API testing

---

## Tasks

### Task 6.1: API Discovery & Documentation (5 minutes)

Map out all available API endpoints:
1. Find the API documentation (Swagger/OpenAPI)
2. List all discovered endpoints
3. Identify authentication requirements for each

**Hints:**
- Check `/api-docs`, `/swagger.json`, `/api/swagger.json`
- Analyze JavaScript for API calls
- Use browser network tab while navigating

---

### Task 6.2: Mass Assignment Attack (10 minutes)

Exploit mass assignment vulnerabilities:
1. Register a new user
2. Analyze the user object structure
3. Attempt to assign yourself additional privileges

**Target:** User registration and update endpoints

**Hints:**
- Look for role, isAdmin, or permission fields
- Try adding extra fields in POST/PUT requests
- Check the user model structure from API responses

---

### Task 6.3: Business Logic Exploitation (10 minutes)

Exploit business logic flaws:
1. Manipulate the shopping cart for financial gain
2. Apply discounts incorrectly
3. Exploit the coupon system

**Targets:**
- `/api/BasketItems/`
- `/rest/basket/{id}/coupon/{coupon}`
- `/api/Quantitys/`

**Hints:**
- Try negative quantities
- Apply coupons multiple times
- Modify prices in requests

---

## API Testing Commands

```bash
# Basic API Discovery
curl -s http://localhost:3000/api-docs | jq

# User Registration with Mass Assignment
curl -X POST http://localhost:3000/api/Users/ \
  -H "Content-Type: application/json" \
  -d '{"email":"test@test.com","password":"test123","role":"admin"}'

# Get User Info (with token)
curl http://localhost:3000/rest/user/whoami \
  -H "Authorization: Bearer <token>"

# Basket Manipulation
curl -X PUT http://localhost:3000/api/BasketItems/1 \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{"quantity": -5}'

# Coupon Application
curl -X PUT http://localhost:3000/rest/basket/1/coupon/DISCOUNT \
  -H "Authorization: Bearer <token>"
```

---

## Business Logic Test Cases

| Test | Expected | Vulnerable Behavior |
|------|----------|---------------------|
| Negative quantity | Error | Accepts, reduces total |
| Negative price | Error | Accepts, credits account |
| Coupon reuse | Error on second use | Allows multiple uses |
| Zero payment | Error | Completes order |
| Order without items | Error | Creates empty order |

---

## Challenge: Advanced API Exploitation

1. Can you get items for free using negative quantities?
2. Can you create coupons through the API?
3. Can you access another user's wallet?
4. Can you exploit any race conditions?

---

## Race Condition Testing

```bash
# Parallel coupon application
for i in {1..10}; do
  curl -X PUT http://localhost:3000/rest/basket/1/coupon/DISCOUNT \
    -H "Authorization: Bearer <token>" &
done
wait
```

---

## Success Criteria

- [ ] Found API documentation
- [ ] Exploited mass assignment to gain privileges
- [ ] Manipulated cart for financial gain
- [ ] Documented all API vulnerabilities

---

## Notes

Document your findings:

```
API Endpoints Discovered:
1. 
2. 
3. 

Mass Assignment:
- Endpoint: 
- Vulnerable Field: 
- Result: 

Business Logic Flaws:
1. Flaw: 
   - Endpoint: 
   - Exploitation: 

2. Flaw: 
   - Endpoint: 
   - Exploitation: 
```

---

**Congratulations!** You've completed the Red Team exercises!

## Summary Report Template

Use this template to create your final attack report:

```
# Red Team Assessment Report

## Executive Summary
[Brief overview of findings]

## Critical Findings
1. [Finding 1]
2. [Finding 2]

## Detailed Findings

### SQL Injection
- Severity: Critical
- Location: 
- Impact: 
- Exploitation: 

### XSS
- Severity: High
- Location: 
- Impact: 
- Exploitation: 

### Access Control
- Severity: High
- Location: 
- Impact: 
- Exploitation: 

## Recommendations
1. 
2. 
3. 
```
